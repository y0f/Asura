name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24"

      - name: Rebuild Tailwind CSS
        run: |
          curl -sL -o tailwindcss "https://github.com/tailwindlabs/tailwindcss/releases/download/v4.2.1/tailwindcss-linux-x64"
          chmod +x tailwindcss
          ./tailwindcss -i web/tailwind.input.css -o web/static/tailwind.css --minify
          ./tailwindcss -i docs/tailwind.input.css -o docs/static/docs.css --minify

      - name: Build binaries
        run: |
          VERSION=${GITHUB_REF_NAME}
          LDFLAGS="-s -w -X main.version=${VERSION}"
          mkdir -p dist

          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -trimpath -ldflags="${LDFLAGS}" -o dist/asura-linux-amd64 ./cmd/asura
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -trimpath -ldflags="${LDFLAGS}" -o dist/asura-linux-arm64 ./cmd/asura

          cd dist
          sha256sum asura-* > checksums.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/asura-linux-amd64
            dist/asura-linux-arm64
            dist/checksums.txt
