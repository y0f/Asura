package views

import (
	"fmt"
	"strings"

	"github.com/y0f/asura/internal/storage"
)

type MonitorFormParams struct {
	LayoutParams
	Monitor              *storage.Monitor
	HTTP                 storage.HTTPSettings
	TCP                  storage.TCPSettings
	DNS                  storage.DNSSettings
	TLS                  storage.TLSSettings
	WS                   storage.WebSocketSettings
	Cmd                  storage.CommandSettings
	Docker               storage.DockerSettings
	Domain               storage.DomainSettings
	GRPC                 storage.GRPCSettings
	MQTT                 storage.MQTTSettings
	FollowRedirects      bool
	MaxRedirects         int
	HeadersJSON          string
	WsHeadersJSON        string
	AssertionsJSON       string
	SettingsJSON         string
	AssertionsRaw        string
	Groups               []*storage.MonitorGroup
	NotificationChannels []*storage.NotificationChannel
	SelectedChannelIDs   []int64
	Proxies              []*storage.Proxy
	AllTags              []*storage.Tag
	SelectedTags         []storage.MonitorTag
}

func (p MonitorFormParams) isTagSelected(tagID int64) bool {
	for _, t := range p.SelectedTags {
		if t.TagID == tagID {
			return true
		}
	}
	return false
}

func (p MonitorFormParams) tagValue(tagID int64) string {
	for _, t := range p.SelectedTags {
		if t.TagID == tagID {
			return t.Value
		}
	}
	return ""
}

func (p MonitorFormParams) cmdArgsStr() string {
	return strings.Join(p.Cmd.Args, ", ")
}

func (p MonitorFormParams) monitorTypeOrDefault() string {
	if p.Monitor.Type != "" {
		return p.Monitor.Type
	}
	return "http"
}

func (p MonitorFormParams) httpMethodOrDefault() string {
	if p.HTTP.Method != "" {
		return p.HTTP.Method
	}
	return "GET"
}

func monitorFormXData(monType, httpMethod, authMethod, headersJSON, wsHeadersJSON, assertionsJSON string) string {
	return `{
    monitorType: '` + JSEscapeString(monType) + `',
    advancedSettings: false,
    advancedAssertions: false,
    httpHeaders: ` + headersJSON + `,
    wsHeaders: ` + wsHeadersJSON + `,
    assertions: ` + assertionsJSON + `,
    httpMethod: '` + JSEscapeString(httpMethod) + `',
    authMethod: '` + JSEscapeString(authMethod) + `',
    operatorsFor(type) {
        switch(type) {
            case 'status_code': case 'response_time': case 'cert_expiry':
                return [['eq','='],['neq','!='],['gt','>'],['lt','<'],['gte','>='],['lte','<=']];
            case 'body_contains':
                return [['contains','contains'],['not_contains','not contains']];
            case 'body_regex':
                return [['matches','matches'],['not_matches','not matches']];
            case 'json_path':
                return [['eq','='],['neq','!='],['gt','>'],['lt','<'],['contains','contains'],['exists','exists']];
            case 'header':
                return [['eq','='],['neq','!='],['contains','contains'],['exists','exists']];
            case 'dns_record':
                return [['contains','contains'],['eq','=']];
            default:
                return [['eq','='],['neq','!=']];
        }
    },
    needsTarget(type) {
        return type === 'json_path' || type === 'header';
    },
    needsValue(op) {
        return op !== 'exists';
    }
}`
}

func tagSelectorData(p MonitorFormParams) string {
	var b strings.Builder
	b.WriteString("{tags:[")
	for i, tag := range p.AllTags {
		if i > 0 {
			b.WriteByte(',')
		}
		fmt.Fprintf(&b, "{id:%d,name:'%s',color:'%s',on:%v,val:'%s'}",
			tag.ID, JSEscapeString(tag.Name), JSEscapeString(tag.Color),
			p.isTagSelected(tag.ID), JSEscapeString(p.tagValue(tag.ID)))
	}
	b.WriteString("],toggleTag(i){this.tags[i].on=!this.tags[i].on;if(!this.tags[i].on)this.tags[i].val=''}}")
	return b.String()
}

func intOrDefault(v, def int) string {
	if v != 0 {
		return fmt.Sprint(v)
	}
	return fmt.Sprint(def)
}

templ MonitorFormPage(p MonitorFormParams) {
	@Layout(p.LayoutParams) {
		<div x-cloak x-data={ monitorFormXData(p.monitorTypeOrDefault(), p.httpMethodOrDefault(), p.HTTP.AuthMethod, p.HeadersJSON, p.WsHeadersJSON, p.AssertionsJSON) }>
			<h1 class="text-[15px] font-medium text-white mb-5">{ p.Title }</h1>
			<form method="POST"
				if p.Monitor.ID != 0 {
					action={ templ.SafeURL(fmt.Sprintf("%s/monitors/%d", p.BasePath, p.Monitor.ID)) }
				} else {
					action={ templ.SafeURL(p.BasePath + "/monitors") }
				}
				class="max-w-4xl space-y-4">
				<!-- Basic Info -->
				<div class="border border-line rounded-lg p-5 space-y-4">
					<div>
						<label class="form-label">Name</label>
						<input type="text" name="name" value={ p.Monitor.Name } required class="form-input"/>
					</div>
					<div>
						<label class="form-label">Description <span class="text-muted/50 font-normal">(optional, max 5000 chars)</span></label>
						<textarea name="description" rows="2" maxlength="5000" placeholder="Runbook notes, context, linksâ€¦" class="form-input resize-y">{ p.Monitor.Description }</textarea>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label class="form-label">Type</label>
							<select name="type" x-model="monitorType" class="form-select">
								<option value="http">HTTP</option>
								<option value="tcp">TCP</option>
								<option value="dns">DNS</option>
								<option value="icmp">ICMP</option>
								<option value="tls">TLS</option>
								<option value="websocket">WebSocket</option>
								<option value="command">Command</option>
								<option value="docker">Docker</option>
								<option value="domain">Domain</option>
								<option value="grpc">gRPC</option>
								<option value="mqtt">MQTT</option>
								<option value="heartbeat">Heartbeat</option>
							</select>
						</div>
						<div x-show="monitorType !== 'heartbeat'">
							<label class="form-label" x-text="monitorType === 'docker' ? 'Container Name / ID' : 'Target'">Target</label>
							<input type="text" name="target" value={ p.Monitor.Target } :placeholder="{http:'https://example.com', tcp:'host:port', dns:'example.com', icmp:'8.8.8.8', tls:'example.com', websocket:'wss://example.com/ws', command:'/usr/bin/check', docker:'nginx, postgres, or container ID', domain:'example.com', grpc:'host:port', mqtt:'broker.example.com:1883'}[monitorType] || 'https://example.com'" class="form-input"/>
						</div>
					</div>
					<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
						<div>
							<label class="form-label">Interval (s)</label>
							<input type="number" name="interval" value={ intOrDefault(p.Monitor.Interval, 60) } min="5" max="86400" class="form-input tabular-nums"/>
						</div>
						<div>
							<label class="form-label">Timeout (s)</label>
							<input type="number" name="timeout" value={ intOrDefault(p.Monitor.Timeout, 10) } min="1" max="300" class="form-input tabular-nums"/>
						</div>
						<div>
							<label class="form-label">Fail Threshold</label>
							<input type="number" name="failure_threshold" value={ intOrDefault(p.Monitor.FailureThreshold, 3) } min="1" class="form-input tabular-nums"/>
						</div>
						<div>
							<label class="form-label">Pass Threshold</label>
							<input type="number" name="success_threshold" value={ intOrDefault(p.Monitor.SuccessThreshold, 1) } min="1" class="form-input tabular-nums"/>
						</div>
					</div>
					if len(p.AllTags) > 0 {
						<div x-data={ tagSelectorData(p) }>
							<label class="form-label">Tags</label>
							<div class="flex flex-wrap gap-1.5">
								for i, tag := range p.AllTags {
									<button type="button"
										@click={ fmt.Sprintf("toggleTag(%d)", i) }
										:class={ fmt.Sprintf("tags[%d].on ? 'border-brand/30 bg-brand/[0.06]' : 'border-line hover:border-line-light'", i) }
										class="inline-flex items-center gap-1 rounded border px-1.5 py-0.5 text-[11px] transition-colors cursor-pointer select-none">
										<span class="w-1.5 h-1.5 rounded-full shrink-0" style={ "background-color: " + tag.Color }></span>
										<span :class={ fmt.Sprintf("tags[%d].on ? 'text-white' : 'text-muted-light'", i) }>{ tag.Name }</span>
									</button>
								}
							</div>
							<template x-if="tags.some(t => t.on)">
								<div class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
									<template x-for="(t, i) in tags" :key="t.id">
										<template x-if="t.on">
											<div class="flex items-center gap-2 rounded border border-line px-3 py-2">
												<input type="hidden" name="tag_ids[]" :value="t.id"/>
												<span class="w-1.5 h-1.5 rounded-full shrink-0" :style="'background-color:' + t.color"></span>
												<span class="text-[11px] text-muted-light shrink-0" x-text="t.name"></span>
												<input type="text" name="tag_values[]" :value="t.val" @input="t.val = $event.target.value" placeholder="value (optional)"
													class="form-input py-1 text-[12px] flex-1 min-w-0"/>
											</div>
										</template>
									</template>
								</div>
							</template>
						</div>
					}
					if len(p.Groups) > 0 {
						<div>
							<label class="form-label">Group</label>
							<select name="group_id" class="form-select">
								<option value="">No group</option>
								for _, g := range p.Groups {
									<option value={ fmt.Sprint(g.ID) }
										if p.Monitor.GroupID != nil && *p.Monitor.GroupID == g.ID {
											selected
										}>{ g.Name }</option>
								}
							</select>
						</div>
					}
					if len(p.Proxies) > 0 {
						<div>
							<label class="form-label">Proxy</label>
							<select name="proxy_id" class="form-select">
								<option value="">No proxy</option>
								for _, px := range p.Proxies {
									<option value={ fmt.Sprint(px.ID) }
										if p.Monitor.ProxyID != nil && *p.Monitor.ProxyID == px.ID {
											selected
										}>{ fmt.Sprintf("%s (%s://%s:%d)", px.Name, px.Protocol, px.Host, px.Port) }</option>
								}
							</select>
						</div>
					}
					if len(p.NotificationChannels) > 0 {
						<div>
							<label class="form-label">Notification Channels</label>
							<p class="text-[10px] text-muted mb-2">Leave all unchecked to use all channels.</p>
							<div class="flex flex-wrap gap-1.5">
								for _, ch := range p.NotificationChannels {
									<label class="inline-flex items-center gap-1 rounded border px-1.5 py-0.5 text-[11px] transition-colors cursor-pointer select-none has-checked:border-brand/30 has-checked:bg-brand/[0.06] border-line hover:border-line-light">
										<input type="checkbox" name="notification_channel_ids[]" value={ fmt.Sprint(ch.ID) }
											if InSlice(ch.ID, p.SelectedChannelIDs) {
												checked
											}
											class="hidden"/>
										<span class="text-muted-light">{ ch.Name }</span>
										<span class="text-muted">({ ch.Type })</span>
									</label>
								}
							</div>
						</div>
					}
					<div class="flex items-center flex-wrap gap-5">
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" name="track_changes"
								if p.Monitor.TrackChanges {
									checked
								}
								class="form-checkbox"/>
							<span class="text-[12px] text-muted-light">Track changes</span>
						</label>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" name="upside_down"
								if p.Monitor.UpsideDown {
									checked
								}
								class="form-checkbox"/>
							<span class="text-[12px] text-muted-light">Upside-down mode</span>
						</label>
					</div>
					<div>
						<label class="form-label">Resend Notification Interval (s)</label>
						<input type="number" name="resend_interval" value={ fmt.Sprint(p.Monitor.ResendInterval) } min="0" placeholder="0 = disabled" class="form-input max-w-[200px] tabular-nums"/>
						<p class="text-[10px] text-muted mt-1">Resend notification every N seconds while down (0 = disabled)</p>
					</div>
				</div>
				<!-- Settings -->
				<div class="border border-line rounded-lg p-5" x-show="monitorType !== 'heartbeat' && monitorType !== 'icmp'" x-cloak>
					<div class="flex items-center justify-between mb-4">
						<span class="text-[11px] text-muted uppercase tracking-widest">Settings</span>
						<button type="button" @click="advancedSettings = !advancedSettings" class="text-[11px] text-brand hover:text-brand/80 transition-colors">
							<span x-text="advancedSettings ? 'Form Mode' : 'Advanced (JSON)'"></span>
						</button>
					</div>
					<input type="hidden" name="settings_mode" :value="advancedSettings ? 'json' : 'form'"/>
					<div x-show="advancedSettings" x-cloak>
						<textarea name="settings_json" rows="8" placeholder="{}" class="form-input font-mono resize-y">{ p.SettingsJSON }</textarea>
					</div>
					<div x-show="!advancedSettings" class="space-y-4">
						@monitorHTTPSettings(p)
						@monitorTCPSettings(p)
						@monitorDNSSettings(p)
						@monitorTLSSettings(p)
						@monitorWSSettings(p)
						@monitorCommandSettings(p)
						@monitorDockerSettings(p)
						@monitorDomainSettings(p)
						@monitorGRPCSettings(p)
						@monitorMQTTSettings(p)
					</div>
				</div>
				<!-- Assertions -->
				@monitorAssertions(p)
				<div class="flex items-center gap-3">
					<button type="submit" class="btn-primary px-5">
						if p.Monitor.ID != 0 {
							Update
						} else {
							Create
						}
					</button>
					<a
						if p.Monitor.ID != 0 {
							href={ templ.SafeURL(fmt.Sprintf("%s/monitors/%d", p.BasePath, p.Monitor.ID)) }
						} else {
							href={ templ.SafeURL(p.BasePath + "/monitors") }
						}
						class="text-[13px] text-muted hover:text-muted-light transition-colors">Cancel</a>
				</div>
			</form>
		</div>
	}
}

templ monitorHTTPSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'http'" x-cloak class="space-y-4">
		<div class="grid grid-cols-2 gap-4">
			<div>
				<label class="form-label">Method</label>
				<select name="settings_method" x-model="httpMethod" class="form-select">
					<option value="GET">GET</option>
					<option value="POST">POST</option>
					<option value="PUT">PUT</option>
					<option value="PATCH">PATCH</option>
					<option value="DELETE">DELETE</option>
					<option value="HEAD">HEAD</option>
					<option value="OPTIONS">OPTIONS</option>
				</select>
			</div>
			<div>
				<label class="form-label">Expected Status</label>
				<input type="number" name="settings_expected_status"
					if p.HTTP.ExpectedStatus != 0 {
						value={ fmt.Sprint(p.HTTP.ExpectedStatus) }
					}
					placeholder="200" class="form-input tabular-nums"/>
			</div>
		</div>
		<div x-show="httpMethod === 'POST' || httpMethod === 'PUT' || httpMethod === 'PATCH'" x-cloak class="space-y-4">
			<div>
				<label class="form-label">Body Encoding</label>
				<select name="settings_body_encoding" class="form-select">
					<option value="json" selected?={ p.HTTP.BodyEncoding == "json" }>JSON</option>
					<option value="xml" selected?={ p.HTTP.BodyEncoding == "xml" }>XML</option>
					<option value="form" selected?={ p.HTTP.BodyEncoding == "form" }>Form</option>
					<option value="raw" selected?={ p.HTTP.BodyEncoding == "raw" }>Raw</option>
				</select>
			</div>
			<div>
				<label class="form-label">Body</label>
				<textarea name="settings_body" rows="3" placeholder="Request body" class="form-input font-mono resize-y">{ p.HTTP.Body }</textarea>
			</div>
		</div>
		<div>
			<label class="form-label">Headers</label>
			<div class="space-y-2">
				<template x-for="(h, i) in httpHeaders" :key="i">
					<div class="flex gap-2">
						<input type="text" :name="'settings_header_key[]'" x-model="h.key" placeholder="Header Name" class="form-input flex-1"/>
						<input type="text" :name="'settings_header_value[]'" x-model="h.value" placeholder="Value" class="form-input flex-1"/>
						<button type="button" @click="httpHeaders.splice(i, 1)" class="px-2 text-red-400 hover:text-red-300 transition-colors text-[16px]">&times;</button>
					</div>
				</template>
			</div>
			<button type="button" @click="httpHeaders.push({key:'', value:''})" class="mt-2 text-[12px] text-brand hover:text-brand/80 transition-colors">+ Add Header</button>
		</div>
		<div class="space-y-3">
			<div>
				<label class="form-label">Authentication</label>
				<select name="settings_auth_method" x-model="authMethod" class="form-select">
					<option value="none">None</option>
					<option value="basic">Basic Auth</option>
					<option value="bearer">Bearer Token</option>
				</select>
			</div>
			<div x-show="authMethod === 'basic'" x-cloak class="grid grid-cols-2 gap-4">
				<div>
					<label class="form-label">Username</label>
					<input type="text" name="settings_basic_auth_user" value={ p.HTTP.BasicAuthUser } class="form-input"/>
				</div>
				<div>
					<label class="form-label">Password</label>
					<input type="password" name="settings_basic_auth_pass" value={ p.HTTP.BasicAuthPass } class="form-input"/>
				</div>
			</div>
			<div x-show="authMethod === 'bearer'" x-cloak>
				<label class="form-label">Token</label>
				<input type="password" name="settings_bearer_token" value={ p.HTTP.BearerToken } class="form-input"/>
			</div>
		</div>
		<div>
			<label class="form-label">Max Redirects</label>
			<input type="number" name="settings_max_redirects" value={ fmt.Sprint(p.MaxRedirects) } min="0" max="30" class="form-input max-w-[200px] tabular-nums"/>
			<p class="text-[10px] text-muted mt-1">0 = don't follow redirects</p>
		</div>
		<div class="flex items-center flex-wrap gap-5">
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_skip_tls_verify"
					if p.HTTP.SkipTLSVerify {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Ignore TLS/SSL errors</span>
			</label>
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_cache_buster"
					if p.HTTP.CacheBuster {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Cache buster</span>
			</label>
		</div>
	</div>
}

templ monitorTCPSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'tcp'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Send Data</label>
			<input type="text" name="settings_send_data" value={ p.TCP.SendData } placeholder="Optional data to send" class="form-input"/>
		</div>
		<div>
			<label class="form-label">Expect Data</label>
			<input type="text" name="settings_expect_data" value={ p.TCP.ExpectData } placeholder="Expected response" class="form-input"/>
		</div>
	</div>
}

templ monitorDNSSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'dns'" x-cloak class="space-y-4">
		<div class="grid grid-cols-2 gap-4">
			<div>
				<label class="form-label">Record Type</label>
				<select name="settings_record_type" class="form-select">
					<option value="A" selected?={ p.DNS.RecordType == "A" }>A</option>
					<option value="AAAA" selected?={ p.DNS.RecordType == "AAAA" }>AAAA</option>
					<option value="CNAME" selected?={ p.DNS.RecordType == "CNAME" }>CNAME</option>
					<option value="MX" selected?={ p.DNS.RecordType == "MX" }>MX</option>
					<option value="TXT" selected?={ p.DNS.RecordType == "TXT" }>TXT</option>
					<option value="NS" selected?={ p.DNS.RecordType == "NS" }>NS</option>
					<option value="SOA" selected?={ p.DNS.RecordType == "SOA" }>SOA</option>
				</select>
			</div>
			<div>
				<label class="form-label">DNS Server</label>
				<input type="text" name="settings_dns_server" value={ p.DNS.Server } placeholder="Optional (e.g. 8.8.8.8)" class="form-input"/>
			</div>
		</div>
	</div>
}

templ monitorTLSSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'tls'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Warning Days Before Expiry</label>
			<input type="number" name="settings_warn_days_before" value={ intOrDefault(p.TLS.WarnDaysBefore, 30) } min="1" max="365" class="form-input max-w-[200px] tabular-nums"/>
		</div>
	</div>
}

templ monitorWSSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'websocket'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Headers</label>
			<div class="space-y-2">
				<template x-for="(h, i) in wsHeaders" :key="i">
					<div class="flex gap-2">
						<input type="text" :name="'settings_ws_header_key[]'" x-model="h.key" placeholder="Header Name" class="form-input flex-1"/>
						<input type="text" :name="'settings_ws_header_value[]'" x-model="h.value" placeholder="Value" class="form-input flex-1"/>
						<button type="button" @click="wsHeaders.splice(i, 1)" class="px-2 text-red-400 hover:text-red-300 transition-colors text-[16px]">&times;</button>
					</div>
				</template>
			</div>
			<button type="button" @click="wsHeaders.push({key:'', value:''})" class="mt-2 text-[12px] text-brand hover:text-brand/80 transition-colors">+ Add Header</button>
		</div>
		<div>
			<label class="form-label">Send Message</label>
			<input type="text" name="settings_send_message" value={ p.WS.SendMessage } placeholder="Optional message to send" class="form-input"/>
		</div>
		<div>
			<label class="form-label">Expect Reply</label>
			<input type="text" name="settings_expect_reply" value={ p.WS.ExpectReply } placeholder="Expected reply" class="form-input"/>
		</div>
	</div>
}

templ monitorCommandSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'command'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Command</label>
			<input type="text" name="settings_command" value={ p.Cmd.Command } placeholder="/usr/bin/check-health" class="form-input"/>
		</div>
		<div>
			<label class="form-label">Arguments</label>
			<input type="text" name="settings_args" value={ p.cmdArgsStr() } placeholder="--verbose, --timeout=5" class="form-input"/>
			<p class="text-[10px] text-muted mt-1">Comma-separated</p>
		</div>
	</div>
}

templ monitorDockerSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'docker'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Container Name / ID</label>
			<input type="text" name="settings_container_name" value={ p.Docker.ContainerName } placeholder="my-container or abc123def" class="form-input"/>
			<p class="text-[10px] text-muted mt-1">Overrides target if set</p>
		</div>
		<div>
			<label class="form-label">Docker Socket Path</label>
			<input type="text" name="settings_socket_path" value={ p.Docker.SocketPath } placeholder="/var/run/docker.sock" class="form-input"/>
			<p class="text-[10px] text-muted mt-1">Default: /var/run/docker.sock</p>
		</div>
		<div class="flex items-center flex-wrap gap-5">
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_check_health"
					if p.Docker.CheckHealth {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Check container health status</span>
			</label>
		</div>
	</div>
}

templ monitorDomainSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'domain'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Warning Days Before Expiry</label>
			<input type="number" name="settings_domain_warn_days" value={ intOrDefault(p.Domain.WarnDaysBefore, 30) } min="1" max="365" class="form-input max-w-[200px] tabular-nums"/>
			<p class="text-[10px] text-muted mt-1">Mark as degraded when domain expires within this many days</p>
		</div>
	</div>
}

templ monitorGRPCSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'grpc'" x-cloak class="space-y-4">
		<div>
			<label class="form-label">Service Name</label>
			<input type="text" name="settings_grpc_service" value={ p.GRPC.ServiceName } placeholder="Leave empty for overall health" class="form-input"/>
			<p class="text-[10px] text-muted mt-1">gRPC service to check (empty = all services)</p>
		</div>
		<div class="flex items-center flex-wrap gap-5">
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_grpc_tls"
					if p.GRPC.UseTLS {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Use TLS</span>
			</label>
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_grpc_skip_verify"
					if p.GRPC.SkipTLSVerify {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Skip TLS verification</span>
			</label>
		</div>
	</div>
}

templ monitorMQTTSettings(p MonitorFormParams) {
	<div x-show="monitorType === 'mqtt'" x-cloak class="space-y-4">
		<div class="grid grid-cols-2 gap-4">
			<div>
				<label class="form-label">Client ID</label>
				<input type="text" name="settings_mqtt_client_id" value={ p.MQTT.ClientID } placeholder="asura-monitor" class="form-input"/>
			</div>
			<div>
				<label class="form-label">Topic</label>
				<input type="text" name="settings_mqtt_topic" value={ p.MQTT.Topic } placeholder="Optional subscribe topic" class="form-input"/>
			</div>
		</div>
		<div class="grid grid-cols-2 gap-4">
			<div>
				<label class="form-label">Username</label>
				<input type="text" name="settings_mqtt_username" value={ p.MQTT.Username } placeholder="Optional" class="form-input"/>
			</div>
			<div>
				<label class="form-label">Password</label>
				<input type="password" name="settings_mqtt_password" value={ p.MQTT.Password } placeholder="Optional" class="form-input"/>
			</div>
		</div>
		<div>
			<label class="form-label">Expected Message</label>
			<input type="text" name="settings_mqtt_expect" value={ p.MQTT.ExpectMessage } placeholder="Optional message content to expect" class="form-input"/>
		</div>
		<div class="flex items-center flex-wrap gap-5">
			<label class="flex items-center gap-2 cursor-pointer">
				<input type="checkbox" name="settings_mqtt_tls"
					if p.MQTT.UseTLS {
						checked
					}
					class="form-checkbox"/>
				<span class="text-[12px] text-muted-light">Use TLS</span>
			</label>
		</div>
	</div>
}

templ monitorAssertions(p MonitorFormParams) {
	<div class="border border-line rounded-lg p-5">
		<div class="flex items-center justify-between mb-4">
			<span class="text-[11px] text-muted uppercase tracking-widest">Assertions</span>
			<button type="button" @click="advancedAssertions = !advancedAssertions" class="text-[11px] text-brand hover:text-brand/80 transition-colors">
				<span x-text="advancedAssertions ? 'Form Mode' : 'Advanced (JSON)'"></span>
			</button>
		</div>
		<input type="hidden" name="assertions_mode" :value="advancedAssertions ? 'json' : 'form'"/>
		<div x-show="advancedAssertions" x-cloak>
			<textarea name="assertions_json" rows="6" placeholder="[]" class="form-input font-mono resize-y">{ p.AssertionsRaw }</textarea>
		</div>
		<div x-show="!advancedAssertions">
			<input type="hidden" name="assertion_count" :value="assertions.length"/>
			<div x-show="assertions.length === 0" class="text-[12px] text-muted py-2">No assertions configured</div>
			<div class="space-y-3">
				<template x-for="(a, i) in assertions" :key="i">
					<div class="border border-line/50 rounded p-3 space-y-3">
						<div class="flex items-center justify-between">
							<span class="text-[11px] text-muted" x-text="'Assertion ' + (i+1)"></span>
							<button type="button" @click="assertions.splice(i, 1)" class="text-red-400 hover:text-red-300 transition-colors text-[14px]">&times;</button>
						</div>
						<div class="grid grid-cols-2 gap-3">
							<div>
								<label class="form-label-sm">Type</label>
								<select :name="'assertion_type_' + i" x-model="a.type" class="form-select py-1.5 text-[12px]">
									<option value="status_code">Status Code</option>
									<option value="body_contains">Body Contains</option>
									<option value="body_regex">Body Regex</option>
									<option value="json_path">JSON Path</option>
									<option value="header">Header</option>
									<option value="response_time">Response Time</option>
									<option value="cert_expiry">Cert Expiry</option>
									<option value="dns_record">DNS Record</option>
								</select>
							</div>
							<div>
								<label class="form-label-sm">Operator</label>
								<select :name="'assertion_operator_' + i" x-model="a.operator" class="form-select py-1.5 text-[12px]">
									<template x-for="op in operatorsFor(a.type)" :key="op[0]">
										<option :value="op[0]" x-text="op[1]"></option>
									</template>
								</select>
							</div>
						</div>
						<div class="grid gap-3" :class="needsTarget(a.type) ? 'grid-cols-2' : 'grid-cols-1'">
							<div x-show="needsTarget(a.type)">
								<label class="form-label-sm">Target</label>
								<input type="text" :name="'assertion_target_' + i" x-model="a.target" placeholder="e.g. $.status or Content-Type" class="form-input py-1.5 text-[12px]"/>
							</div>
							<div x-show="needsValue(a.operator)">
								<label class="form-label-sm">Value</label>
								<input type="text" :name="'assertion_value_' + i" x-model="a.value" placeholder="Expected value" class="form-input py-1.5 text-[12px]"/>
							</div>
						</div>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" :name="'assertion_degraded_' + i" :checked="a.degraded" class="form-checkbox w-3 h-3"/>
							<span class="text-[11px] text-muted-light">Soft (mark as degraded instead of down)</span>
						</label>
					</div>
				</template>
			</div>
			<button type="button" @click="assertions.push({type:'status_code', operator:'eq', target:'', value:'', degraded:false})" class="mt-3 text-[12px] text-brand hover:text-brand/80 transition-colors">+ Add Assertion</button>
		</div>
	</div>
}
