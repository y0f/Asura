{{define "title"}}Monitors{{end}}
{{define "content"}}
<div x-data="{
    selected: [],
    allIds: [{{range .Data.Result.Data}}{{.ID}},{{end}}],
    get allSelected() { return this.allIds.length > 0 && this.selected.length === this.allIds.length },
    toggleAll() { this.selected = this.allSelected ? [] : [...this.allIds] },
    toggle(id) {
        const i = this.selected.indexOf(id);
        if (i === -1) this.selected.push(id); else this.selected.splice(i, 1);
    },
    bulkAction: '',
    bulkGroupId: ''
}">
    <div class="flex items-center justify-between mb-5">
        <h1 class="text-[15px] font-medium text-white">Monitors</h1>
        {{if index .Perms "monitors.write"}}
        <a href="{{$.BasePath}}/monitors/new" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-brand hover:bg-brand/85 text-white text-[12px] font-medium rounded transition-colors">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14m7-7H5"/></svg>
            New Monitor
        </a>
        {{end}}
    </div>

    <form method="GET" action="{{.BasePath}}/monitors" class="mb-4">
        {{if .Data.Type}}<input type="hidden" name="type" value="{{.Data.Type}}">{{end}}
        <div class="relative max-w-xs">
            <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" name="q" value="{{.Data.Search}}" placeholder="Search monitors..."
                   class="w-full pl-8 pr-3 py-1.5 bg-transparent border border-line rounded text-[12px] text-white placeholder-muted/50 focus:outline-hidden focus:border-brand/40 transition-colors">
        </div>
    </form>

    <div class="flex gap-1.5 mb-4 overflow-x-auto pb-1">
        <a href="{{$.BasePath}}/monitors{{if .Data.Search}}?q={{.Data.Search}}{{end}}" class="filter-tab {{if and (not .Data.Type) (not .Data.TagFilter)}}filter-active{{else}}filter-inactive{{end}}">All</a>
        {{$search := .Data.Search}}{{$curType := .Data.Type}}{{$curTag := .Data.TagFilter}}
        {{range $type := (list "http" "tcp" "dns" "icmp" "tls" "websocket" "command" "heartbeat" "docker" "domain" "grpc" "mqtt")}}
        <a href="{{$.BasePath}}/monitors?type={{$type}}{{if $search}}&q={{$search}}{{end}}" class="filter-tab {{if eq $curType $type}}filter-active{{else}}filter-inactive{{end}}">{{typeLabel $type}}</a>
        {{end}}
        {{range .Data.AllTags}}
        <a href="{{$.BasePath}}/monitors?tag={{.ID}}{{if $search}}&q={{$search}}{{end}}{{if $curType}}&type={{$curType}}{{end}}" class="filter-tab {{if and $curTag (eq (deref $curTag) .ID)}}filter-active{{else}}filter-inactive{{end}} inline-flex items-center gap-1">
            <span class="inline-block w-1.5 h-1.5 rounded-full" style="background-color: {{.Color}}"></span>{{.Name}}
        </a>
        {{end}}
    </div>

    {{if index .Perms "monitors.write"}}
    <div x-show="selected.length > 0" x-cloak class="mb-3 px-4 py-2.5 border border-brand/30 bg-brand/5 rounded-lg flex items-center gap-3 flex-wrap">
        <span class="text-[12px] text-white font-medium" x-text="selected.length + ' selected'"></span>
        <form method="POST" action="{{$.BasePath}}/monitors/bulk" x-ref="bulkForm" class="contents">
            <template x-for="id in selected" :key="id">
                <input type="hidden" name="ids[]" :value="id">
            </template>
            <input type="hidden" name="action" :value="bulkAction">
            <input type="hidden" name="group_id" :value="bulkGroupId">
            <button type="button" @click="bulkAction='pause'; $nextTick(() => $refs.bulkForm.submit())"
                    class="px-2.5 py-1 text-[11px] text-yellow-400 border border-yellow-500/20 rounded hover:bg-yellow-500/5 transition-colors">Pause</button>
            <button type="button" @click="bulkAction='resume'; $nextTick(() => $refs.bulkForm.submit())"
                    class="px-2.5 py-1 text-[11px] text-emerald-400 border border-emerald-500/20 rounded hover:bg-emerald-500/5 transition-colors">Resume</button>
            {{if .Data.Groups}}
            <select x-model="bulkGroupId" @change="if(bulkGroupId !== '') { bulkAction='set_group'; $nextTick(() => $refs.bulkForm.submit()) }"
                    class="px-2 py-1 text-[11px] bg-transparent border border-line rounded text-muted-light focus:border-brand/40 focus:outline-hidden">
                <option value="">Set Group...</option>
                <option value="0">No Group</option>
                {{range .Data.Groups}}
                <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
            {{end}}
            <button type="button" @click="if(confirm('Delete ' + selected.length + ' monitors?')) { bulkAction='delete'; $nextTick(() => $refs.bulkForm.submit()) }"
                    class="px-2.5 py-1 text-[11px] text-red-400 border border-red-500/20 rounded hover:bg-red-500/5 transition-colors">Delete</button>
            <button type="button" @click="selected = []" class="px-2 py-1 text-[11px] text-muted hover:text-muted-light transition-colors">Clear</button>
        </form>
    </div>
    {{end}}

    <div id="monitor-list" hx-get="" hx-trigger="every 30s" hx-select="#monitor-list" hx-swap="outerHTML" hx-push-url="false"
         class="border border-line rounded-lg overflow-hidden">
        {{if and .Data.Result .Data.Result.Data}}
        <div class="overflow-x-auto">
            <table class="w-full min-w-[640px]">
                <thead>
                    <tr class="border-b border-line text-left">
                        {{if index $.Perms "monitors.write"}}
                        <th class="th w-8">
                            <input type="checkbox" :checked="allSelected" @change="toggleAll()" class="form-checkbox">
                        </th>
                        {{end}}
                        <th class="th">Monitor</th>
                        <th class="th">Type</th>
                        <th class="th">Status</th>
                        <th class="th">Last Check</th>
                        <th class="th text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-line">
                    {{range .Data.Result.Data}}
                    <tr class="hover:bg-surface-200/20 transition-colors" :class="selected.includes({{.ID}}) && 'bg-brand/5'">
                        {{if index $.Perms "monitors.write"}}
                        <td class="px-4 py-3">
                            <input type="checkbox" :checked="selected.includes({{.ID}})" @change="toggle({{.ID}})" class="form-checkbox">
                        </td>
                        {{end}}
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-1.5">
                                <a href="{{$.BasePath}}/monitors/{{.ID}}" class="text-[13px] text-muted-light hover:text-white transition-colors font-medium">{{.Name}}</a>
                                {{$monID := .ID}}{{range index $.Data.TagMap $monID}}
                                <span class="inline-block w-1.5 h-1.5 rounded-full shrink-0" style="background-color: {{.Color}}" title="{{.Name}}{{if .Value}}: {{.Value}}{{end}}"></span>
                                {{end}}
                            </div>
                            <div class="text-[11px] text-muted mt-0.5 truncate max-w-xs font-mono">{{.Target}}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-[10px] text-brand uppercase tracking-wider">{{typeLabel .Type}}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full {{statusDot .Status}} {{if eq .Status "down"}}animate-pulse-dot{{end}}"></div>
                                <span class="text-[12px] {{statusColor .Status}}">{{.Status}}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-[12px] text-muted">
                            {{if .LastCheckAt}}{{timeAgo .LastCheckAt}}{{else}}<span class="text-muted/40">—</span>{{end}}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                {{if index $.Perms "monitors.write"}}
                                {{if .Enabled}}
                                <form method="POST" action="{{$.BasePath}}/monitors/{{.ID}}/pause" class="contents">
                                    <button type="submit" class="inline-flex items-center text-muted hover:text-yellow-400 transition-colors" title="Pause">
                                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                    </button>
                                </form>
                                {{else}}
                                <form method="POST" action="{{$.BasePath}}/monitors/{{.ID}}/resume" class="contents">
                                    <button type="submit" class="inline-flex items-center text-muted hover:text-emerald-400 transition-colors" title="Resume">
                                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                    </button>
                                </form>
                                {{end}}
                                {{end}}
                                <a href="{{$.BasePath}}/monitors/{{.ID}}" class="inline-flex items-center text-muted hover:text-white transition-colors" title="View">
                                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </a>
                                {{if index $.Perms "monitors.write"}}
                                <a href="{{$.BasePath}}/monitors/{{.ID}}/edit" class="inline-flex items-center text-muted hover:text-brand transition-colors" title="Edit">
                                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </a>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{if gt .Data.Result.TotalPages 1}}
        <div class="px-4 py-2.5 border-t border-line flex items-center justify-between">
            <span class="text-[11px] text-muted tabular-nums">Page {{.Data.Result.Page}} / {{.Data.Result.TotalPages}} · {{.Data.Result.Total}} monitors</span>
            <div class="flex gap-1">
                {{if gt .Data.Result.Page 1}}
                <a href="{{$.BasePath}}/monitors?page={{sub .Data.Result.Page 1}}{{if .Data.Type}}&type={{.Data.Type}}{{end}}{{if .Data.Search}}&q={{.Data.Search}}{{end}}{{if .Data.TagFilter}}&tag={{deref .Data.TagFilter}}{{end}}" class="inline-flex items-center justify-center w-6 h-6 text-muted-light hover:text-white border border-line rounded hover:border-line-light transition-colors"><svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></a>
                {{end}}
                {{if lt .Data.Result.Page .Data.Result.TotalPages}}
                <a href="{{$.BasePath}}/monitors?page={{add .Data.Result.Page 1}}{{if .Data.Type}}&type={{.Data.Type}}{{end}}{{if .Data.Search}}&q={{.Data.Search}}{{end}}{{if .Data.TagFilter}}&tag={{deref .Data.TagFilter}}{{end}}" class="inline-flex items-center justify-center w-6 h-6 text-muted-light hover:text-white border border-line rounded hover:border-line-light transition-colors"><svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></a>
                {{end}}
            </div>
        </div>
        {{end}}
        {{else}}
        <div class="px-4 py-16 text-center">
            {{if or .Data.Search .Data.Type}}
            <p class="text-muted text-[13px] mb-2">No monitors match your search</p>
            <a href="{{$.BasePath}}/monitors" class="text-[12px] text-brand hover:text-brand/80 transition-colors">Clear filters</a>
            {{else}}
            <p class="text-muted text-[13px] mb-2">No monitors configured</p>
            <a href="{{$.BasePath}}/monitors/new" class="text-[12px] text-brand hover:text-brand/80 transition-colors">Create your first monitor</a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>
{{end}}
