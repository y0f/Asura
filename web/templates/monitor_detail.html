{{define "title"}}{{.Data.Monitor.Name}}{{end}}
{{define "content"}}
{{$mon := .Data.Monitor}}
<div id="monitor-detail" hx-get="" hx-trigger="every 15s" hx-select="#monitor-detail" hx-swap="outerHTML" hx-push-url="false">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
        <div>
            <a href="{{$.BasePath}}/monitors" class="inline-flex items-center gap-1 text-[11px] text-muted hover:text-muted-light transition-colors"><svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>Monitors</a>
            <div class="flex items-center gap-2.5 mt-1.5">
                <div class="w-2 h-2 rounded-full {{statusDot $mon.Status}} {{if eq $mon.Status "down"}}animate-pulse-dot{{end}}"></div>
                <h1 class="text-[17px] font-medium text-white">{{$mon.Name}}</h1>
                <span class="text-[10px] font-medium tracking-wide px-1.5 py-px rounded border {{statusBg $mon.Status}}">{{$mon.Status}}</span>
                {{if not $mon.Enabled}}<span class="text-[10px] tracking-wide px-1.5 py-px rounded border border-line text-muted">paused</span>{{end}}
            </div>
            <div class="text-[11px] text-muted mt-1 ml-[18px] font-mono">{{typeLabel $mon.Type}} · {{$mon.Target}} · {{$mon.Interval}}s interval · {{$mon.Timeout}}s timeout</div>
        </div>
        {{if index $.Perms "monitors.write"}}
        <div class="flex items-center gap-1.5 flex-shrink-0">
            {{if $mon.Enabled}}
            <form method="POST" action="{{$.BasePath}}/monitors/{{$mon.ID}}/pause">
                <button type="submit" class="px-2.5 py-1 text-[11px] text-muted border border-line rounded hover:text-yellow-400 hover:border-yellow-500/20 transition-colors">Pause</button>
            </form>
            {{else}}
            <form method="POST" action="{{$.BasePath}}/monitors/{{$mon.ID}}/resume">
                <button type="submit" class="px-2.5 py-1 text-[11px] text-emerald-400 border border-emerald-500/20 rounded hover:bg-emerald-500/5 transition-colors">Resume</button>
            </form>
            {{end}}
            <a href="{{$.BasePath}}/monitors/{{$mon.ID}}/edit" class="px-2.5 py-1 text-[11px] text-brand border border-brand/20 rounded hover:bg-brand/5 transition-colors">Edit</a>
            <form method="POST" action="{{$.BasePath}}/monitors/{{$mon.ID}}/delete" x-data @submit.prevent="if(confirm('Delete this monitor?')) $el.submit()">
                <button type="submit" class="px-2.5 py-1 text-[11px] text-red-400 border border-red-500/20 rounded hover:bg-red-500/5 transition-colors">Delete</button>
            </form>
        </div>
        {{end}}
    </div>

    {{if .Data.OpenIncident}}
    <div class="mb-5 px-4 py-2.5 border border-red-500/15 rounded text-[13px] text-red-400 flex items-center gap-2">
        <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Active incident: {{.Data.OpenIncident.Cause}}
        <a href="{{$.BasePath}}/incidents/{{.Data.OpenIncident.ID}}" class="text-red-400/80 hover:text-red-300 underline underline-offset-2 ml-1">View &rarr;</a>
    </div>
    {{end}}

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-5">
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">Uptime 24h</div>
            <div class="text-lg font-semibold {{uptimeColor .Data.Uptime24h}} tabular-nums">{{uptimeFmt .Data.Uptime24h}}</div>
        </div>
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">Uptime 7d</div>
            <div class="text-lg font-semibold {{uptimeColor .Data.Uptime7d}} tabular-nums">{{uptimeFmt .Data.Uptime7d}}</div>
        </div>
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">Uptime 30d</div>
            <div class="text-lg font-semibold {{uptimeColor .Data.Uptime30d}} tabular-nums">{{uptimeFmt .Data.Uptime30d}}</div>
        </div>
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">Checks 24h</div>
            <div class="text-lg font-semibold text-white tabular-nums">{{.Data.TotalChecks}}</div>
            {{if gt .Data.TotalChecks 0}}
            <div class="flex items-center gap-2 mt-0.5">
                <span class="text-[10px] text-emerald-400">{{.Data.UpChecks}} up</span>
                {{if gt .Data.DownChecks 0}}<span class="text-[10px] text-red-400">{{.Data.DownChecks}} down</span>{{end}}
            </div>
            {{end}}
        </div>
    </div>

    {{if or (eq $mon.Type "http") (eq $mon.Type "tcp") (eq $mon.Type "dns") (eq $mon.Type "icmp") (eq $mon.Type "websocket")}}
    <div class="grid grid-cols-3 gap-3 mb-5">
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">p50</div>
            <div class="text-lg font-semibold text-white tabular-nums font-mono">{{formatFloat .Data.P50}}</div>
        </div>
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">p95</div>
            <div class="text-lg font-semibold text-white tabular-nums font-mono">{{formatFloat .Data.P95}}</div>
        </div>
        <div class="border border-line rounded-lg px-4 py-3">
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">p99</div>
            <div class="text-lg font-semibold text-white tabular-nums font-mono">{{formatFloat .Data.P99}}</div>
        </div>
    </div>
    {{end}}

    <div id="response-chart" hx-preserve="true" class="border border-line rounded-lg px-4 py-3 mb-5" x-data="{
        range: '24h',
        loading: true,
        chart: null,
        points: [],
        async fetchData() {
            this.loading = true;
            try {
                const resp = await fetch('{{$.BasePath}}/monitors/{{$mon.ID}}/chart?range=' + this.range, {credentials: 'same-origin'});
                const data = await resp.json();
                this.points = data.points || [];
            } catch(e) {
                this.points = [];
            }
            this.loading = false;
            this.$nextTick(() => this.render());
        },
        render() {
            const el = this.$refs.chart;
            const tip = this.$refs.tooltip;
            if (!el || !this.points.length) return;
            if (this.chart) { this.chart.destroy(); this.chart = null; }

            const ts = this.points.map(p => p.ts);
            const rt = this.points.map(p => p.rt);
            const statuses = this.points.map(p => p.s);
            const tipDate = tip ? tip.querySelector('.tip-date') : null;
            const tipVal = tip ? tip.querySelector('.tip-value') : null;
            const tipSt = tip ? tip.querySelector('.tip-status') : null;

            const opts = {
                width: el.clientWidth,
                height: 200,
                cursor: { show: true, drag: { x: false, y: false } },
                select: { show: false },
                legend: { show: false },
                padding: [12, 8, 0, 0],
                axes: [
                    {
                        stroke: '#434656',
                        grid: { stroke: '#1a1a22', width: 1 },
                        ticks: { stroke: '#1a1a22', width: 1 },
                        font: '10px Inter, system-ui, sans-serif',
                        gap: 6
                    },
                    {
                        stroke: '#434656',
                        grid: { stroke: '#1a1a22', width: 1 },
                        ticks: { stroke: '#1a1a22', width: 1 },
                        font: '10px Inter, system-ui, sans-serif',
                        gap: 6,
                        values: (u, vals) => vals.map(v => v + 'ms')
                    }
                ],
                series: [
                    {},
                    {
                        label: 'Response Time',
                        stroke: '#0080ff',
                        width: 1.5,
                        fill: 'rgba(0,128,255,0.06)',
                        points: {
                            show: false
                        }
                    }
                ],
                hooks: {
                    draw: [
                        (u) => {
                            const ctx = u.ctx;
                            const { left, top, width, height } = u.bbox;
                            for (let i = 0; i < statuses.length; i++) {
                                if (statuses[i] !== 'down') continue;
                                const x = Math.round(u.valToPos(ts[i], 'x', true));
                                ctx.save();
                                ctx.fillStyle = 'rgba(248,113,113,0.15)';
                                const bw = Math.max(2, width / statuses.length);
                                ctx.fillRect(x - bw/2, top, bw, height);
                                ctx.restore();
                            }
                        }
                    ],
                    setCursor: [
                        (u) => {
                            if (!tip) return;
                            const idx = u.cursor.idx;
                            if (idx == null) { tip.style.display = 'none'; return; }
                            const t = new Date(ts[idx] * 1000);
                            const time = t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                            const date = t.toLocaleDateString([], {month:'short',day:'numeric'});
                            if (tipDate) tipDate.textContent = date + ' ' + time;
                            if (tipVal) tipVal.textContent = rt[idx] + 'ms';
                            if (tipSt) { tipSt.textContent = statuses[idx] === 'down' ? 'down' : ''; tipSt.style.display = statuses[idx] === 'down' ? '' : 'none'; }
                            tip.style.display = 'block';
                            const cx = u.valToPos(ts[idx], 'x', true);
                            const tipW = tip.offsetWidth;
                            let lx = cx + 12;
                            if (lx + tipW > el.clientWidth) lx = cx - tipW - 12;
                            tip.style.left = lx + 'px';
                            tip.style.top = '8px';
                        }
                    ]
                }
            };

            this.chart = new uPlot(opts, [ts, rt], el);
        },
        resizeObs: null,
        init() {
            this.fetchData();
            this.resizeObs = new ResizeObserver(() => {
                if (this.chart && this.$refs.chart) {
                    this.chart.setSize({width: this.$refs.chart.clientWidth, height: 200});
                }
            });
            this.$nextTick(() => { if (this.$refs.chart) this.resizeObs.observe(this.$refs.chart); });
        },
        destroy() { if (this.resizeObs) this.resizeObs.disconnect(); if (this.chart) this.chart.destroy(); }
    }" x-init="init()" @beforeunload.window="destroy()" x-cloak>
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-[11px] text-muted uppercase tracking-widest">Response Time</h2>
            <div class="flex gap-1">
                <template x-for="r in ['1h','6h','24h','7d','30d']" :key="r">
                    <button @click="range = r; fetchData()"
                        :class="range === r ? 'text-brand bg-brand/[0.08] border-brand/20' : 'text-muted hover:text-muted-light border-line hover:border-line-light'"
                        class="px-2 py-0.5 text-[10px] border rounded transition-colors" x-text="r"></button>
                </template>
            </div>
        </div>
        <div x-show="loading" class="h-[200px] flex items-center justify-center">
            <div class="text-[11px] text-muted">Loading chart...</div>
        </div>
        <div x-show="!loading && !points.length" class="h-[200px] flex items-center justify-center">
            <div class="text-[11px] text-muted">No data for this time range</div>
        </div>
        <div x-show="!loading && points.length" class="relative">
            <div x-ref="chart"></div>
            <div x-ref="tooltip" class="chart-tooltip absolute pointer-events-none bg-surface-100 border border-line rounded px-2 py-1.5 z-10" style="display:none">
                <div class="tip-date text-[10px] text-muted"></div>
                <div class="tip-value text-[12px] text-white font-mono"></div>
                <div class="tip-status text-[10px] text-red-400" style="display:none"></div>
            </div>
        </div>
    </div>

    {{if and .Data.LatestCheck (eq $mon.Type "tls")}}
    {{if .Data.LatestCheck.CertExpiry}}
    <div class="border border-line rounded-lg px-4 py-3 mb-5 flex items-center justify-between">
        <div>
            <div class="text-[10px] text-muted uppercase tracking-widest mb-1">TLS Certificate</div>
            <div class="text-[13px] font-medium {{certColor .Data.LatestCheck.CertExpiry}}">{{certDays .Data.LatestCheck.CertExpiry}} days remaining</div>
        </div>
        <div class="text-[11px] text-muted font-mono">{{.Data.LatestCheck.CertExpiry.Format "2006-01-02"}}</div>
    </div>
    {{end}}
    {{end}}

    {{if and .Data.LatestCheck (eq $mon.Type "dns")}}
    {{$records := parseDNS .Data.LatestCheck.DNSRecords}}
    {{if $records}}
    <div class="border border-line rounded-lg px-4 py-3 mb-5">
        <div class="text-[10px] text-muted uppercase tracking-widest mb-2">DNS Records</div>
        <div class="space-y-0.5">{{range $records}}<div class="text-[12px] text-muted-light font-mono">{{.}}</div>{{end}}</div>
    </div>
    {{end}}
    {{end}}

    <div class="border border-line rounded-lg px-4 py-3 mb-5">
        <div class="text-[10px] text-muted uppercase tracking-widest mb-2">Configuration</div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-1.5 text-[12px]">
            <div><span class="text-muted">Interval</span> <span class="text-muted-light ml-1">{{$mon.Interval}}s</span></div>
            <div><span class="text-muted">Timeout</span> <span class="text-muted-light ml-1">{{$mon.Timeout}}s</span></div>
            <div><span class="text-muted">Fail threshold</span> <span class="text-muted-light ml-1">{{$mon.FailureThreshold}}</span></div>
            <div><span class="text-muted">Success threshold</span> <span class="text-muted-light ml-1">{{$mon.SuccessThreshold}}</span></div>
            <div><span class="text-muted">Enabled</span> <span class="{{if $mon.Enabled}}text-emerald-400{{else}}text-muted{{end}} ml-1">{{if $mon.Enabled}}yes{{else}}no{{end}}</span></div>
            {{if $mon.TrackChanges}}<div><span class="text-muted">Track changes</span> <span class="text-brand ml-1">yes</span></div>{{end}}
            {{if $mon.Tags}}<div class="col-span-full"><span class="text-muted">Tags</span> <span class="text-muted-light ml-1">{{range $i, $t := $mon.Tags}}{{if $i}}, {{end}}{{$t}}{{end}}</span></div>{{end}}
        </div>
    </div>

    <div class="border border-line rounded-lg mb-5 overflow-hidden">
        <div class="px-4 py-2.5 border-b border-line">
            <h2 class="text-[11px] text-muted uppercase tracking-widest">Recent Checks</h2>
        </div>
        {{if and $.Data.Checks $.Data.Checks.Data}}
        <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
                <thead>
                    <tr class="border-b border-line text-left">
                        <th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Status</th>
                        <th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Response</th>
                        {{if or (eq $mon.Type "http") (eq $mon.Type "websocket")}}<th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Code</th>{{end}}
                        {{if eq $mon.Type "tls"}}<th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Cert</th>{{end}}
                        <th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Message</th>
                        <th class="px-4 py-2 text-[10px] font-medium text-muted uppercase tracking-widest">Time</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-line">
                    {{range $.Data.Checks.Data}}
                    <tr class="hover:bg-surface-200/20 transition-colors">
                        <td class="px-4 py-2">
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full {{statusDot .Status}}"></div>
                                <span class="text-[11px] {{statusColor .Status}}">{{.Status}}</span>
                            </div>
                        </td>
                        <td class="px-4 py-2 text-[11px] text-muted-light tabular-nums font-mono">{{formatMs .ResponseTime}}</td>
                        {{if or (eq $mon.Type "http") (eq $mon.Type "websocket")}}
                        <td class="px-4 py-2 text-[11px] tabular-nums font-mono {{if .StatusCode}}{{httpStatusColor .StatusCode}}{{else}}text-muted/30{{end}}">{{if .StatusCode}}{{.StatusCode}}{{else}}—{{end}}</td>
                        {{end}}
                        {{if eq $mon.Type "tls"}}
                        <td class="px-4 py-2 text-[11px] {{certColor .CertExpiry}}">{{if .CertExpiry}}{{certDays .CertExpiry}}d{{else}}—{{end}}</td>
                        {{end}}
                        <td class="px-4 py-2 text-[11px] text-muted truncate max-w-[200px]">{{if .Message}}{{.Message}}{{else}}—{{end}}</td>
                        <td class="px-4 py-2 text-[11px] text-muted/60">{{timeAgo .CreatedAt}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="px-4 py-10 text-center text-muted text-[12px]">No check results yet</div>
        {{end}}
    </div>

    {{if and $.Data.Changes $.Data.Changes.Data}}
    <div class="border border-line rounded-lg overflow-hidden">
        <div class="px-4 py-2.5 border-b border-line">
            <h2 class="text-[11px] text-muted uppercase tracking-widest">Content Changes</h2>
        </div>
        <div class="divide-y divide-line">
            {{range $.Data.Changes.Data}}
            <div class="px-4 py-3">
                <div class="text-[10px] text-muted/60 mb-1.5">{{timeAgo .CreatedAt}}</div>
                {{if .Diff}}<pre class="text-[11px] text-muted-light bg-surface rounded p-3 overflow-x-auto font-mono">{{.Diff}}</pre>{{end}}
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>
{{end}}
